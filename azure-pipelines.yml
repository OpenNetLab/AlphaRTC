# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
  branches:
    include:
    - "*"
    exclude:
    - upstream/*

jobs:
- job: Windows
  pool:
    name: AlphaRTC-build
    vmImage: VS2017-Win2016

  variables:
  - name: DEPOT_TOOLS_WIN_TOOLCHAIN
    value: 0
  - name: GYP_MSVS_VERSION
    value: 2017

  steps:

    - powershell: |
        Invoke-WebRequest -Uri "https://storage.googleapis.com/chrome-infra/depot_tools.zip" -OutFile "depot_tools.zip"
        Expand-Archive "./depot_tools.zip"
      workingDirectory: $(Pipeline.Workspace)
      displayName: "clone depot_tools"

    - powershell: |
        Write-Host "##vso[task.prependpath]$(Pipeline.Workspace)/depot_tools"
      displayName: "set path"
    
    - powershell: gclient sync
      displayName: "sync dependencies"
    
    - powershell: |
        Get-ChildItem -Path "src" -Recurse | Move-Item -Destination "."
        Remove-Item 'src'
      displayName: "move src"
    
    - powershell: gn gen out/Default
      displayName: "generate build rules"
    
    - powershell: ninja -C out/Default peerconnection_serverless
      displayName: "make peerconnection"
